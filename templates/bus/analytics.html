<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ–±—É—Å–∞–º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      width: 100%;
      height: 400px;
    }
    .card-title {
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container py-4">
    <h1 class="mb-5 text-center">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ–±—É—Å–∞–º</h1>

    <div class="row">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="col-md-4">
        <div class="card mb-3 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–±—É—Å:</h5>
            <form method="get">
              <select name="bus" class="form-select mb-3" onchange="this.form.submit()">
                <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
                {% for bus in buses %}
                  <option value="{{ bus.id }}" {% if bus.id|stringformat:"s" == selected_id %}selected{% endif %}>
                    Bus {{ bus.bus_number }}
                  </option>
                {% endfor %}
              </select>
            </form>

            {% if level %}
              <div class="alert {% if level == '–û–≥—Ä–æ–º–Ω—ã–π –ø–æ—Ç–æ–∫' %}alert-danger{% else %}alert-success{% endif %}">
                <strong>–£—Ä–æ–≤–µ–Ω—å –ø–æ—Ç–æ–∫–∞:</strong> {{ level }}
              </div>
            {% endif %}

            {% if interval %}
              <div class="alert alert-primary">
                üìè –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: <strong>{{ interval }} –º–∏–Ω</strong>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="col-md-8">
        {% if chart_data %}
          {{ chart_data|json_script:"chart-data" }}
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">–ì—Ä–∞—Ñ–∏–∫ –≤—Ö–æ–¥–æ–≤ –ø–æ —á–∞—Å–∞–º</h5>
              <div class="chart-container">
                <canvas id="trafficChart"></canvas>
              </div>
            </div>
          </div>

          <script>
            const rawData = JSON.parse(document.getElementById("chart-data").textContent);
            const labels = rawData.map(item => item.hour);
            const counts = rawData.map(item => item.count);

            const ctx = document.getElementById('trafficChart').getContext('2d');
            const chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: '–ö–æ–ª-–≤–æ –≤—Ö–æ–¥–æ–≤ –ø–æ —á–∞—Å–∞–º',
                  data: counts,
                  borderColor: 'rgba(13, 110, 253, 1)',
                  backgroundColor: 'rgba(13, 110, 253, 0.2)',
                  tension: 0.3,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    title: { display: true, text: '–í—Ä–µ–º—è' }
                  },
                  y: {
                    title: { display: true, text: '–ü–∞—Å—Å–∞–∂–∏—Ä—ã' },
                    beginAtZero: true
                  }
                }
              }
            });
          </script>
        {% elif selected_id %}
          <div class="alert alert-warning text-center">
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∞–≤—Ç–æ–±—É—Å—É.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
